<%- include('../partials/header') %>

<body class="explore">
  <!--? USER PROFILE TILE -->



  <div class="container d-flex justify-content-center align-items-center">
             
    <div class="pp tile">

     <div class="upper">

       <img src="https://wallpaperaccess.com/full/39608.jpg" class="img-fluid">
       
     </div>

     <div class="user text-center">

       <!-- <div class="profile"> -->

         <img src="<%=user.avatar%>" id="rounded-circle" width="80">
         
       <!-- </div> -->

     </div>


     <div class="mt-5 text-center">

       <h4 class="mb-0"><a class="tile" href="/user/<%=user._id%>"><%=user.name%></a></h4>
       <span class="text-muted d-block mb-2">@coderrJSmithy</span>

       <div class="item item-3">
        <div class="flex-ctr">
          <h3>Your Projects</h3>
        </div>
      </div>
  
      <div class="item item-4">
        <div class="flex-ctr">
          <h3>Your Bookmarks</h3>
        </div>
      </div>
  

       <button class="btn btn-primary btn-sm follow new-project">+ Add Project</button>


       <div class="d-flex justify-content-between align-items-center mt-4 px-4">

         <div class="stats">
           <h6 class="mb-0">Followers</h6>
           <span>8,797</span>

         </div>


         <div class="stats">
           <h6 class="mb-0">Projects</h6>
           <span>142</span>

         </div>


         <div class="stats">
           <h6 class="mb-0">Ranks</h6>
           <span>129</span>

         </div>
         
       </div>
       
     </div>
      
    </div>

  </div>



  <!-- PROJECTS FEED -->

  <main class="flex-ctr">
    <div id="project-list">
      <% projects.forEach(function(project) { %>
        <div class="project-tile">
          <div class="container mt-5 mb-5">
            <div class="row d-flex align-items-center justify-content-center">
                <div class="col-md-6">
                    <div class="proj card">
                        <div class="d-flex justify-content-between p-2 px-3">
                            <div class="d-flex flex-row align-items-center"> <img src="<%=user.avatar%>" width="50" class="rounded-circle">
                                <div class="d-flex flex-column ml-2"> <span class="font-weight-bold"><%= project.createdBy ? project.createdBy.name : 'Unknown' %></span> <small class="text-primary"> <a href="<%= project.projectURL %>">View Project</a></small> </div>
                            </div>
                            <div class="d-flex flex-row mt-1 ellipsis"> <small class="mr-2"><%=project.timestamps%></small> <i class="fa fa-ellipsis-h"></i> </div>
                        </div> 
                        <div class="p-2">
                            <p class="text-justify"><%=project.description%>></p>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex flex-row icons d-flex align-items-center"> <i class="fa fa-heart"></i> <i class="fa fa-smile-o ml-2"></i> </div>
                                <form action="/projects/<%= project._id %>?_method=DELETE" method="POST">
                                  <button type="submit">X</button>
                                </form>
                                <form action="/projects/like/<%= project._id %>" method="POST">
                                  <button type="submit">Like</button>
                                </form>
                                <p>Likes: <%= project.likes ? project.likes.length : 0 %></p>
                                <div class="d-flex flex-row muted-color"> <span>Comments</span> <span class="ml-2"><a href="/projects/save/<%= project._id %>">Bookmark</a></span> </div>
                            </div>
                            
                            <hr>
                            <% project.comments.forEach(function(comment) { %>
                              <div class="comments">
                                <div class="d-flex flex-row mb-2"> 
                                  <img src="<%= comment.author.avatar %>" width="40" class="rounded-image">
                                  <div class="d-flex flex-column ml-2"> 
                                    <span class="name"><%= user.name %></span> 
                    
                                    <small class="comment-text"><%= comment.text %></small>
                                    <div class="comment d-flex flex-row align-items-center status"> 
                                      <small>Like</small> <small>Save</small> 
                                      <small><%= comment.created_at %></small> 
                                      <form action="/projects/<%= project._id %>/comments/<%= comment._id %>?_method=DELETE" method="POST">
                                        <button type="submit">X</button>
                                      </form>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            <% }); %>
                            <div class="comment-input">
                              <form action="/projects/<%= project._id %>/comments" method="POST">
                                <input type="text" name="text" class="form-control">
                                <button type="submit" class="comment-button">Send</button>
                              </form>
                            </div>
                          </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      <% }); %>
    </div>
</main>

  <!-- NEW POST -->
  <form id="new-post" action="/projects" method="POST">
    <div class="bg-modal">
      <div class="modal-content">
        <div class="new-post-container">
          <div class="row">
            <div class="col-md-8 col-md-offset-2">
              <h1>Create post</h1>
              <button type="button" class="close">+</button>

              <div class="form-group has-error" name="name"><h2><%=user.name%></h2>
              </div>

              <div class="form-group has-error" name="name">
            </div>
            <div class="form-group has-error" name="gitUsername" >
            </div>

            <div class="form-group has-error" name="avatar"><%=user.avatar%>
            </div>

              <div class="form-group has-error">
                <input type="text" name="projectURL" placeholder="Github project link" >
              </div>


                <div class="form-group">
                  <textarea
                    rows="5"
                    class="form-control"
                    name="description"
                    placeholder="What's your project about?"
                  ></textarea>
                </div>


                <div class="form-group">
                  <button type="submit" class="create">Create</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>

  
  <script>
    // function for hiding popup
    function hidePopup() {
      document.querySelector(".bg-modal").style.display = "none";
    }
  
    // function for adding new post
    async function addNewPost(e) {
      e.preventDefault(); 
  
      let formData = new FormData(this);
  
      let object = {};
  
      formData.forEach(function(value, key){
        object[key] = value;
      });
  
      let json = JSON.stringify(object);
  
      try {
        const response = await fetch('/projects', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: json
        });
        
        const data = await response.json();
        console.log('Success:', data);
  
        hidePopup();
  
        let projectList = document.getElementById("project-list")
  
        let projectDiv = document.createElement("div");
        projectDiv.classList.add("project-tile")
        projectDiv.innerHTML = `
        <h2>${data.user.name}</h2>
        <p>${data.project.description}</p>
        <a href="${data.project.projectURL}">View Project</a>
        `;
  
        projectDiv.style.color = "red";
        projectList.prepend(projectDiv);
  
      } catch (error) {
        console.error('Error:', error);
      }
    };
  
    // function to load all projects on page load
    window.onload = async function() {
      try {
        const response = await fetch('/projects');
        const data = await response.json();
  
        // data should be an array of projects
        data.forEach(project => {
          let projectList = document.getElementById("project-list")
  
          let projectDiv = document.createElement("div");
    projectDiv.classList.add("container", "mt-5", "mb-5");
    projectDiv.innerHTML = `
      <div class="row d-flex align-items-center justify-content-center">
        <div class="col-md-6">
          <div class="proj card">
            <div class="d-flex justify-content-between p-2 px-3">
              <div class="d-flex flex-row align-items-center">
                <img src="${data.user.avatar}" width="50" class="rounded-circle">
                <div class="d-flex flex-column ml-2"> 
                  <span class="font-weight-bold">${data.user.name}</span> 
                  <small class="text-primary"><a href="${data.project.projectURL}">View Project</a></small> 
                </div>
              </div>
              <div class="d-flex flex-row mt-1 ellipsis">
                <small class="mr-2">${new Date().toLocaleString()}</small> 
                <i class="fa fa-ellipsis-h"></i>
              </div>
            </div> 
            <div class="p-2">
              <p class="text-justify">${data.project.description}</p>
              <hr>
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex flex-row icons d-flex align-items-center">
                  <i class="fa fa-heart"></i>
                  <i class="fa fa-smile-o ml-2"></i> 
                </div>
                <div class="d-flex flex-row muted-color">
                  <span>Comments</span>
                  <span class="ml-2">Bookmark</span>
                </div>
              </div>
              <hr>
            </div>
          </div>
        </div>
      </div>
    `;
  
          projectList.prepend(projectDiv);
        });
      } catch (error) {
        console.error('Error:', error);
      }
    }
    
    
//     async function deleteProject(e) {
//   e.preventDefault(); 

//   const id = e.target.elements['id'].value;

//   try {
//     const response = await fetch(`/projects/${id}?_method=DELETE`, {method: 'POST'});
//     const data = await response.json();
    
//     if(data.message) {
//       window.location.href = '/projects'; 
//     } else {
//       console.error(data.error);
//     }
//   } catch (error) {
//     console.error(error);
//   }
// };

    // Event Listeners
    document.querySelector(".new-project").addEventListener("click", function() {
        document.querySelector(".bg-modal").style.display = "flex"
    });
  
    document.querySelector(".close").addEventListener("click", hidePopup)
  
    document.querySelector("#new-post").addEventListener("submit", addNewPost)

    // document.querySelector('#delete-form').addEventListener('submit', deleteProject)

  
  </script>
  
</body>
<%- include('../partials/footer') %>
